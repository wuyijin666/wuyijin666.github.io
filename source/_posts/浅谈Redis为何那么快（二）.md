---
title: 浅谈Redis为何那么快（二）
date: 2024-04-15 15:35:59
tags: 本文探讨Redis之所以快速处理大规模数据的原因
categories: redis
---
# 高效的内存数据结构
![](/images/7.png)
### 动态字符串
动态字符串是一种能够动态扩展长度的字符串实现方式。SDS是Redis中的一种简单动态字符串结构，它是一种动态大小的字节数组，用于存储和操作字符串数据。
```java
/*
 * redis中保存字符串对象的结构
 */
struct sdshdr {
    //用于记录buf数组中使用的字节的数目，和SDS存储的字符串的长度相等 
    int len;
    //用于记录buf数组中没有使用的字节的数目 
    int free;
    //字节数组，用于储存字符串
    char buf[]; //buf的大小等于len+free+1，其中多余的1个字节是用来存储’\0’的
};
```
Redis的SDS的数据结构使用一个len字段记录当前字符串的长度，使用free表示空闲的长度。想要获取长度只需要获取len字段即可。
![](/images/8.png)
而对比C语言，传统字符串是使用长度为N+1的字符数组来表示长度为 的字符串，并且字符串数组的最后一个元素总是空字符'\0'。
SDS相对于C语言字符串有如下优点：
1. **二进制安全** :SDS可以存储任意二进制数据，而不仅仅是文本字符串(包括图片、视频、音频等在内的各种二进制数据)，而不会受到空字符或者特殊字符的限制，具有更广泛的适用性。
2. **动态扩展** : SDS可以根据存储的字符串长度动态调整，根据实际需要动态分配和释放内存空间。
3. **O(1)时间复杂度** 
4. **缓冲区溢出保护** : SDS在存储字符串时，会自动添加一个空字符串（'\O'）作为字符串的结束标志，保证字符串的安全性和稳定性。
5. **惰性空间释放** : 当SDS缩短字符串时，并不会立即释放多余空间，多余空间会保存下来，以备后续再利用。这种惰性空间释放策略可以减少内存分配和释放的开销，提高内存利用率。
### 双端链表
Redis中的双端链表是一种经过优化的数据结构，用于存储有序数据集合。它具有双向连接的特性，每个节点都包含前一个节点和后一个节点的指针。
![](/images/9.png)
在Redis中，双端链表节点的定义通常如下：
```c
typedef struct listNode {
    struct listNode *prev;  // 指向前一个节点的指针
    struct listNode *next;  // 指向后一个节点的指针
    void *value;            // 存储的数据元素
} listNode;
```
对于链表中描述链表整体属性的元数据，它的结构如下：
```c
typedef struct list {
    listNode *head;  // 头节点指针
    listNode *tail;  // 尾节点指针
    unsigned long len;  // 链表长度
    // 其他字段...
} list;
```
1. **头结点**（head node): 头结点是双端链表中的第一个节点，也是链表的入口。通常用于存储链表的起始位置信息，以便快速定位链表的起始位置。在双端链表中，头结点的特点是没有前一个节点，即头结点的 prev 为 NULL。头结点通常用于存储链表的头部元数据或者哨兵节点。
2. **尾结点** (tail node): 尾结点是双端链表中的第一个节点，也是链表的结束位置。通常用于存储链表的结束位置信息，以便快速定位链表的结束位置。在双端链表中，尾结点的特点是没有最后一个节点，即尾结点的 next 为 NULL。尾结点通常用于存储链表的尾部元数据或者哨兵节点。

通过头节点和尾节点，可以方便地对双端链表进行头部插入、尾部插入、头部删除、尾部删除等操作，从而实现了对双端链表的高效操作。
除了上述头尾节点以外，链表的元数据中还有len参数，这个参数用于记录链表的当前长度。每当链表中添加或删除节点时，Redis会相应地更新len字段的值，以反映链表的当前长度。这个参数与SDS里类似，获取链表长度时不用再遍历整个链表，直接拿到len值就可以了，这个时间复杂度是 O(1)。
